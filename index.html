<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>筑肥線 列車位置情報</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #ffffff;
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
        }

        #info-bar {
            background: #e60012;
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #view-container {
            width: 100%;
            height: calc(100vh - 40px);
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #view-area {
            padding: 10px;
            transform-origin: top center;
        }

        /* 列車情報のレイアウト調整 */
        .train-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .train-no-label {
            color: #e60012;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
            margin: 2px 0;
        }

        .arrival-text {
            font-size: 12px;
            color: #333;
        }

        /* 公式テーブルのスタイル維持 */
        table { border-collapse: collapse !important; margin: 0 auto; }
        td { padding: 0 !important; position: relative; text-align: center; }
        img { display: block; margin: 0 auto; }

        /* 不要な要素を隠す */
        #headerArea, .header_menu, .spacer, #footerArea, .footer_copy { display: none !important; }

        #loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 9999;
        }
    </style>
</head>
<body>

<div id="info-bar">
    <span>筑肥線 列車位置（GAS連携版）</span>
    <span id="update-time">読み込み中...</span>
</div>

<div id="loader">データを取得しています...</div>

<div id="view-container">
    <div id="view-area"></div>
</div>

<script>
    /**
     * 【重要】デプロイしたGASのURLをここに貼り付けてください
     */
    const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxHQ54GliWlIkshLkCPXDV_OoLDdgSj8KKe-ry-BjBucg2Hc-meqztMkR_olZd0K3uUkA/exec';
    
    const TARGET_URL = 'https://george-doredore.jrkyushu.co.jp/jrqSEN9.html';
    const BASE_URL = 'https://george-doredore.jrkyushu.co.jp/';

    async function updateBoard() {
        if (!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes('YOUR_GAS')) {
            document.getElementById('loader').innerText = 'GASのURLが設定されていません。';
            return;
        }

        try {
            const fetchUrl = `${GAS_WEBAPP_URL}?url=${encodeURIComponent(TARGET_URL)}`;
            const response = await fetch(fetchUrl);
            const htmlText = await response.text();

            if (!htmlText || htmlText.includes("Error")) throw new Error("Fetch Error");

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');

            // 1. パスの補完（画像やCSS）
            doc.querySelectorAll('[src], [background]').forEach(el => {
                const src = el.getAttribute('src');
                const bg = el.getAttribute('background');
                if (src && !src.startsWith('http')) el.src = new URL(src, BASE_URL).href;
                if (bg && !bg.startsWith('http')) el.setAttribute('background', new URL(bg, BASE_URL).href);
            });

            // 2. 列車番号の埋め込み（定刻の下、アイコンの上）
            doc.querySelectorAll('td[title]').forEach(td => {
                const trainNo = td.getAttribute('title');
                const bg = td.getAttribute('background') || "";
                
                if (trainNo && /\d/.test(trainNo) && !trainNo.includes('KUKAN') && bg.includes('image/M')) {
                    const img = td.querySelector('img');
                    const originalText = td.innerText.trim();
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = 'train-wrapper';

                    // 定刻などのテキスト
                    if (originalText && originalText !== trainNo) {
                        const txt = document.createElement('span');
                        txt.className = 'arrival-text';
                        txt.innerText = originalText;
                        wrapper.appendChild(txt);
                    }

                    // 列車番号
                    const no = document.createElement('span');
                    no.className = 'train-no-label';
                    no.innerText = trainNo;
                    wrapper.appendChild(no);

                    // 列車アイコン
                    if (img) wrapper.appendChild(img.cloneNode(true));

                    td.innerHTML = '';
                    td.appendChild(wrapper);
                }
            });

            // 3. 画面への反映
            const content = doc.getElementById('contentsArea');
            if (content) {
                document.getElementById('view-area').innerHTML = '';
                document.getElementById('view-area').appendChild(content);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('update-time').innerText = '更新: ' + new Date().toLocaleTimeString();
            }

        } catch (e) {
            console.error(e);
            document.getElementById('loader').innerText = 'データの取得に失敗しました。再試行します。';
        }
    }

    // 初回実行と30秒ごとの更新
    updateBoard();
    setInterval(updateBoard, 30000);

    // 簡易的なレスポンシブ調整
    window.addEventListener('resize', () => {
        const vw = document.getElementById('view-container').clientWidth;
        const aw = document.getElementById('view-area').scrollWidth;
        if (aw > vw) {
            const scale = vw / aw;
            document.getElementById('view-area').style.transform = `scale(${scale})`;
        } else {
            document.getElementById('view-area').style.transform = `scale(1)`;
        }
    });
</script>
</body>
</html>
