<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>筑肥線 列車位置表示</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #ffffff;
        }

        #main-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: sans-serif;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="loading-screen">読み込み中...</div>
<iframe id="main-frame"></iframe>

<script>
    const TARGET_URL = 'https://george-doredore.jrkyushu.co.jp/jrqSEN9.html';
    const BASE_URL = 'https://george-doredore.jrkyushu.co.jp/';
    // プロキシをより安定したものに変更
    const PROXY = (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u + '?t=' + Date.now())}`;

    async function loadBoard() {
        const loadingScreen = document.getElementById('loading-screen');
        const iframe = document.getElementById('main-frame');

        try {
            const res = await fetch(PROXY(TARGET_URL));
            if (!res.ok) throw new Error("Fetch failed");

            const buffer = await res.arrayBuffer();
            
            // 1. Shift_JISでデコード
            const decoder = new TextDecoder('shift_jis');
            let rawHtml = decoder.decode(buffer);

            // 2. 列車番号注入スクリプトとスタイルの定義
            const injectorScript = `
                <style>
                    table { border-collapse: collapse !important; border-spacing: 0 !important; }
                    td { position: relative !important; padding: 0 !important; text-align: center !important; vertical-align: middle !important; }
                    .train-no-box {
                        display: block;
                        color: #e60012 !important;
                        font-size: 13px !important;
                        font-family: "Helvetica Neue", Arial, sans-serif !important;
                        font-weight: bold !important;
                        line-height: 1.2 !important;
                        margin: 2px 0;
                        padding: 0;
                    }
                    td img { display: block !important; margin: 0 auto !important; }
                </style>
                <script>
                    function inject() {
                        document.querySelectorAll('td[title]').forEach(td => {
                            const no = td.getAttribute('title');
                            const bg = td.getAttribute('background') || "";
                            if (no && /\\d/.test(no) && !no.includes('KUKAN') && bg.includes('image/M')) {
                                if (!td.querySelector('.train-no-box')) {
                                    const img = td.querySelector('img');
                                    const originalText = td.innerText.trim();
                                    const container = document.createElement('div');
                                    container.style.display = "flex";
                                    container.style.flexDirection = "column";
                                    container.style.alignItems = "center";
                                    
                                    if (originalText && originalText !== no) {
                                        const textSpan = document.createElement('span');
                                        textSpan.innerText = originalText;
                                        textSpan.style.fontSize = "12px";
                                        container.appendChild(textSpan);
                                    }
                                    const noSpan = document.createElement('span');
                                    noSpan.className = 'train-no-box';
                                    noSpan.innerText = no;
                                    container.appendChild(noSpan);
                                    if (img) container.appendChild(img.cloneNode(true));
                                    
                                    td.innerHTML = '';
                                    td.appendChild(container);
                                }
                            }
                        });
                    }
                    window.onload = inject;
                    setInterval(inject, 2000);
                <\/script>
            `;

            // 3. HTMLの加工: パス補完とベースタグ挿入
            let finalHtml = rawHtml
                .replace('<head>', `<head><base href="${BASE_URL}">${injectorScript}`)
                .replace(/src="([^"]+)"/g, (m, p1) => p1.startsWith('http') || p1.startsWith('data:') ? m : `src="${new URL(p1, BASE_URL).href}"`)
                .replace(/background="([^"]+)"/g, (m, p1) => p1.startsWith('http') || p1.startsWith('data:') ? m : `background="${new URL(p1, BASE_URL).href}"`)
                .replace(/href="([^"]+)"/g, (m, p1) => p1.startsWith('http') || p1.startsWith('data:') ? m : `href="${new URL(p1, BASE_URL).href}"`);

            // 4. Blobを使用して、ブラウザに「これはHTMLだ」と正しく認識させて読み込ませる
            const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            iframe.src = url;

            iframe.onload = () => {
                loadingScreen.style.display = 'none';
                // メモリリーク防止のためURLを解放
                setTimeout(() => URL.revokeObjectURL(url), 10000);
            };

        } catch (e) {
            console.error(e);
            loadingScreen.innerText = "取得失敗。再読み込みしてください。";
        }
    }

    loadBoard();
    setInterval(loadBoard, 30000);
</script>
</body>
</html>
