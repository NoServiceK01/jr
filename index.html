<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>筑肥線 列車位置表示</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #ffffff;
        }

        /* iframeを画面いっぱいに広げる */
        #main-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: sans-serif;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="loading-screen">読み込み中（文字化け・レイアウト調整中）...</div>
<iframe id="main-frame" sandbox="allow-same-origin allow-scripts"></iframe>

<script>
    const TARGET_URL = 'https://george-doredore.jrkyushu.co.jp/jrqSEN9.html';
    const BASE_URL = 'https://george-doredore.jrkyushu.co.jp/';
    const PROXY = (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u + '?t=' + Date.now())}`;

    async function loadBoard() {
        const loadingScreen = document.getElementById('loading-screen');
        const iframe = document.getElementById('main-frame');

        // タイムアウト設定: 10秒経っても終わらなければ強制表示
        const timeoutId = setTimeout(() => {
            if (loadingScreen.style.display !== 'none') {
                loadingScreen.style.display = 'none';
            }
        }, 10000);

        try {
            const res = await fetch(PROXY(TARGET_URL));
            if (!res.ok) throw new Error("Fetch failed");

            const buffer = await res.arrayBuffer();
            const decoder = new TextDecoder('shift_jis');
            const rawHtml = decoder.decode(buffer);

            // 1. 列車番号を定刻（テキスト）の下に埋め込むためのスクリプト
            const injectorScript = `
                <style>
                    /* テーブル構造の強制維持 */
                    table { border-collapse: collapse !important; border-spacing: 0 !important; }
                    td { position: relative !important; padding: 0 !important; text-align: center !important; vertical-align: middle !important; }
                    
                    /* 列車番号のスタイル（定刻の下に表示） */
                    .train-no-box {
                        display: block;
                        color: #e60012 !important;
                        font-size: 13px !important;
                        font-family: "Helvetica Neue", Arial, sans-serif !important;
                        font-weight: bold !important;
                        line-height: 1.2 !important;
                        margin: 2px 0;
                        padding: 0;
                    }

                    /* 列車アイコンの調整 */
                    td img {
                        display: block !important;
                        margin: 0 auto !important;
                    }
                </style>
                <script>
                    function inject() {
                        document.querySelectorAll('td[title]').forEach(td => {
                            const no = td.getAttribute('title');
                            const bg = td.getAttribute('background') || "";
                            
                            // 列車アイコンがあるセルを特定
                            if (no && /\\d/.test(no) && !no.includes('KUKAN') && bg.includes('image/M')) {
                                if (!td.querySelector('.train-no-box')) {
                                    const img = td.querySelector('img');
                                    const originalText = td.innerText.trim();
                                    
                                    const container = document.createElement('div');
                                    container.style.display = "flex";
                                    container.style.flexDirection = "column";
                                    container.style.alignItems = "center";
                                    container.style.justifyContent = "center";

                                    if (originalText && originalText !== no) {
                                        const textSpan = document.createElement('span');
                                        textSpan.innerText = originalText;
                                        textSpan.style.fontSize = "12px";
                                        container.appendChild(textSpan);
                                    }

                                    const noSpan = document.createElement('span');
                                    noSpan.className = 'train-no-box';
                                    noSpan.innerText = no;
                                    container.appendChild(noSpan);

                                    if (img) {
                                        container.appendChild(img.cloneNode(true));
                                    }

                                    td.innerHTML = '';
                                    td.appendChild(container);
                                }
                            }
                        });
                    }
                    window.onload = inject;
                    setInterval(inject, 2000);
                <\/script>
            `;

            // 2. 修正したHTMLを構築（全てのパスを絶対URLへ）
            const finalHtml = rawHtml
                .replace('<head>', '<head><base href="' + BASE_URL + '">' + injectorScript)
                .replace(/src="([^"]+)"/g, (m, p1) => p1.startsWith('http') || p1.startsWith('data:') ? m : \`src="\${new URL(p1, BASE_URL).href}"\`)
                .replace(/background="([^"]+)"/g, (m, p1) => p1.startsWith('http') || p1.startsWith('data:') ? m : \`background="\${new URL(p1, BASE_URL).href}"\`)
                .replace(/href="([^"]+)"/g, (m, p1) => p1.startsWith('http') || p1.startsWith('data:') ? m : \`href="\${new URL(p1, BASE_URL).href}"\`);

            iframe.srcdoc = finalHtml;

            iframe.onload = () => {
                clearTimeout(timeoutId);
                loadingScreen.style.display = 'none';
            };

        } catch (e) {
            clearTimeout(timeoutId);
            loadingScreen.innerText = "取得失敗。再読み込みしてください。";
            console.error(e);
        }
    }

    loadBoard();
    setInterval(loadBoard, 30000);
</script>
</body>
</html>
