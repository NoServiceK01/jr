<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>筑肥線 列車位置表示</title>
    <style>
        /* デザインをそのまま引用するため、余計な余白のみリセット */
        body, html {
            margin: 0;
            padding: 0;
            background-color: #ffffff;
        }

        /* 列車番号ラベルのスタイル（元のアイコンの上に重ねる） */
        .train-no-overlay {
            position: absolute;
            background: rgba(230, 0, 18, 0.85);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 13px;
            font-family: sans-serif;
            font-weight: bold;
            pointer-events: none;
            transform: translate(-50%, -100%);
            margin-top: -5px;
            white-space: nowrap;
            z-index: 1000;
        }

        /* 読み込み中の表示 */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="loading-screen">接続中...</div>
<div id="doredore-content"></div>

<script>
    const TARGET_URL = 'https://george-doredore.jrkyushu.co.jp/jrqSEN9.html';
    const BASE_URL = 'https://george-doredore.jrkyushu.co.jp/';
    
    // バイナリで取得するためのプロキシ
    const PROXY = (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u + '?t=' + Date.now())}`;

    async function loadBoard() {
        try {
            const res = await fetch(PROXY(TARGET_URL));
            const buffer = await res.arrayBuffer();
            
            // Shift_JISを強制デコードして文字化けを解消
            const decoder = new TextDecoder('shift_jis');
            const html = decoder.decode(buffer);

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // 1. 画像URLの修正（デザインを壊さないために必須）
            doc.querySelectorAll('[src], [background]').forEach(el => {
                const src = el.getAttribute('src');
                const bg = el.getAttribute('background');
                if (src && !src.startsWith('http')) el.src = new URL(src, BASE_URL).href;
                if (bg && !bg.startsWith('http')) el.setAttribute('background', new URL(bg, BASE_URL).href);
            });

            // 2. 列車番号の重畳表示
            // 元のデザイン（td構造）をいじらず、座標計算で上に乗せる
            const container = document.getElementById('doredore-content');
            container.innerHTML = doc.body.innerHTML;

            const tds = container.querySelectorAll('td[title]');
            tds.forEach(td => {
                const trainNo = td.getAttribute('title');
                const bg = td.getAttribute('background') || "";
                
                if (trainNo && /\d/.test(trainNo) && !trainNo.includes('KUKAN') && bg.includes('image/M')) {
                    const label = document.createElement('div');
                    label.className = 'train-no-overlay';
                    label.innerText = trainNo;
                    
                    // tdの中心位置に配置
                    td.style.position = 'relative';
                    td.appendChild(label);
                    
                    // 中央に配置するための調整
                    label.style.left = "50%";
                    label.style.top = "50%";
                }
            });

            document.getElementById('loading-screen').style.display = 'none';

        } catch (e) {
            document.getElementById('loading-screen').innerText = "取得エラー。再試行中...";
            console.error(e);
        }
    }

    // 初回実行
    loadBoard();
    // 30秒ごとに更新
    setInterval(loadBoard, 30000);
</script>
</body>
</html>
