<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>筑肥線 列車位置表示</title>
    <style>
        /* デザインをそのまま引用するため、余計な余白のみリセット */
        body, html {
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            font-family: "MS PGothic", "Hiragino Kaku Gothic ProN", sans-serif;
        }

        /* 列車番号ラベルのスタイル */
        .train-no-overlay {
            position: absolute;
            background: rgba(230, 0, 18, 0.9);
            color: white;
            padding: 1px 3px;
            border-radius: 2px;
            font-size: 11px;
            font-family: sans-serif;
            font-weight: bold;
            pointer-events: none;
            transform: translate(-50%, -100%);
            margin-top: -2px;
            white-space: nowrap;
            z-index: 1000;
            border: 1px solid white;
        }

        /* 元サイトのテーブルレイアウトを維持するための強制設定 */
        #doredore-content table {
            border-collapse: collapse !important;
            border-spacing: 0 !important;
            margin: 0 !important;
        }

        #doredore-content td {
            padding: 0 !important;
            line-height: 0 !important;
            position: relative;
        }

        /* 読み込み中の表示 */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="loading-screen">接続中...</div>
<div id="doredore-content"></div>

<script>
    const TARGET_URL = 'https://george-doredore.jrkyushu.co.jp/jrqSEN9.html';
    const BASE_URL = 'https://george-doredore.jrkyushu.co.jp/';
    
    // バイナリで取得するためのプロキシ
    const PROXY = (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u + '?t=' + Date.now())}`;

    async function loadBoard() {
        try {
            const res = await fetch(PROXY(TARGET_URL));
            const buffer = await res.arrayBuffer();
            
            // Shift_JISを強制デコード（文字化け解消）
            const decoder = new TextDecoder('shift_jis');
            const html = decoder.decode(buffer);

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // 1. スタイルシートの絶対パス化（セルの線やサイズを直すために必須）
            doc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('http')) {
                    const newLink = document.createElement('link');
                    newLink.rel = 'stylesheet';
                    newLink.href = new URL(href, BASE_URL).href;
                    document.head.appendChild(newLink);
                }
            });

            // 2. 画像と背景URLの修正
            doc.querySelectorAll('[src], [background]').forEach(el => {
                const src = el.getAttribute('src');
                const bg = el.getAttribute('background');
                if (src && !src.startsWith('http')) el.src = new URL(src, BASE_URL).href;
                if (bg && !bg.startsWith('http')) el.setAttribute('background', new URL(bg, BASE_URL).href);
            });

            // 3. コンテンツの反映
            const container = document.getElementById('doredore-content');
            // 元サイトの「contentsArea」だけを抜くと崩れやすいため、body全体を一度解析
            const officialContent = doc.getElementById('contentsArea') || doc.body;
            container.innerHTML = officialContent.innerHTML;

            // 4. 列車番号の重畳表示
            const tds = container.querySelectorAll('td[title]');
            tds.forEach(td => {
                const trainNo = td.getAttribute('title');
                const bg = td.getAttribute('background') || "";
                
                // 列車画像があるセルのみ処理
                if (trainNo && /\d/.test(trainNo) && !trainNo.includes('KUKAN') && bg.includes('image/M')) {
                    const label = document.createElement('div');
                    label.className = 'train-no-overlay';
                    label.innerText = trainNo;
                    
                    td.style.position = 'relative';
                    td.appendChild(label);
                    
                    label.style.left = "50%";
                    label.style.top = "50%";
                }
            });

            document.getElementById('loading-screen').style.display = 'none';

        } catch (e) {
            document.getElementById('loading-screen').innerText = "取得エラー。再試行中...";
            console.error(e);
        }
    }

    loadBoard();
    setInterval(loadBoard, 30000);
</script>
</body>
</html>
