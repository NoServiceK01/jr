<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>筑肥線 列車位置表示</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #ffffff;
        }

        /* iframeを画面いっぱいに広げる */
        #main-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: sans-serif;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="loading-screen">読み込み中（文字化け・デザイン修復中）...</div>
<iframe id="main-frame" sandbox="allow-same-origin allow-scripts"></iframe>

<script>
    const TARGET_URL = 'https://george-doredore.jrkyushu.co.jp/jrqSEN9.html';
    const BASE_URL = 'https://george-doredore.jrkyushu.co.jp/';
    const PROXY = (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u + '?t=' + Date.now())}`;

    async function loadBoard() {
        try {
            const res = await fetch(PROXY(TARGET_URL));
            if (!res.ok) throw new Error("Fetch failed");

            const buffer = await res.arrayBuffer();
            const decoder = new TextDecoder('shift_jis');
            const rawHtml = decoder.decode(buffer);

            const parser = new DOMParser();
            const doc = parser.parseFromString(rawHtml, 'text/html');

            // 1. 全ての相対パスを絶対パスに書き換え（デザイン崩れ防止の核心）
            const fixPath = (attr) => {
                doc.querySelectorAll(`[${attr}]`).forEach(el => {
                    const val = el.getAttribute(attr);
                    if (val && !val.startsWith('http') && !val.startsWith('data:')) {
                        try {
                            el.setAttribute(attr, new URL(val, BASE_URL).href);
                        } catch(e) {}
                    }
                });
            };
            ['src', 'href', 'background', 'action'].forEach(fixPath);

            // 2. 列車番号注入用スクリプトの準備
            const injectorScript = `
                <style>
                    .train-no-label {
                        position: absolute;
                        background: rgba(230, 0, 18, 0.95);
                        color: white !important;
                        padding: 1px 4px;
                        border-radius: 2px;
                        font-size: 12px !important;
                        font-family: sans-serif !important;
                        font-weight: bold !important;
                        pointer-events: none;
                        transform: translate(-50%, -100%);
                        margin-top: -4px;
                        white-space: nowrap;
                        z-index: 9999;
                        border: 1px solid white;
                        line-height: 1.2 !important;
                    }
                    /* テーブル構造の強制維持 */
                    table { border-collapse: collapse !important; border-spacing: 0 !important; }
                    td { position: relative !important; padding: 0 !important; }
                </style>
                <script>
                    function inject() {
                        document.querySelectorAll('td[title]').forEach(td => {
                            const no = td.getAttribute('title');
                            const bg = td.getAttribute('background') || "";
                            if (no && /\\d/.test(no) && !no.includes('KUKAN') && bg.includes('image/M')) {
                                if (!td.querySelector('.train-no-label')) {
                                    const label = document.createElement('div');
                                    label.className = 'train-no-label';
                                    label.innerText = no;
                                    td.style.position = 'relative';
                                    td.appendChild(label);
                                    label.style.left = "50%";
                                    label.style.top = "50%";
                                }
                            }
                        });
                    }
                    window.onload = inject;
                    setInterval(inject, 2000);
                <\/script>
            `;

            // 3. 修正したHTMLを構築
            const headExtra = `
                <base href="${BASE_URL}">
                ${injectorScript}
            `;
            const finalHtml = rawHtml
                .replace('<head>', '<head>' + headExtra)
                .replace(/src="([^"]+)"/g, (m, p1) => p1.startsWith('http') ? m : `src="${new URL(p1, BASE_URL).href}"`)
                .replace(/background="([^"]+)"/g, (m, p1) => p1.startsWith('http') ? m : `background="${new URL(p1, BASE_URL).href}"`)
                .replace(/href="([^"]+)"/g, (m, p1) => p1.startsWith('http') ? m : `href="${new URL(p1, BASE_URL).href}"`);

            // 4. iframeに流し込む（これが一番文字化けしない）
            const iframe = document.getElementById('main-frame');
            iframe.srcdoc = finalHtml;

            iframe.onload = () => {
                document.getElementById('loading-screen').style.display = 'none';
            };

        } catch (e) {
            document.getElementById('loading-screen').innerText = "取得失敗。再読み込みしてください。";
            console.error(e);
        }
    }

    loadBoard();
    // 30秒ごとに全体を更新
    setInterval(loadBoard, 30000);
</script>
</body>
</html>
